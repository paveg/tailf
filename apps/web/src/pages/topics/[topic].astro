---
import Layout from '../../layouts/Layout.astro'
import { PostCard } from '../../components/PostCard'
import { TOPICS, type TopicId } from '@tailf/shared'
import { fetchAllPostsForSSG } from '../../lib/server-api'

// Topic descriptions for SEO
const TOPIC_DESCRIPTIONS: Record<TopicId, string> = {
	ai: 'AI・機械学習・LLMに関する日本語の技術記事を集約。ChatGPT、画像生成、自然言語処理など最新のAI技術情報',
	backend: 'バックエンド開発に関する日本語の技術記事を集約。API設計、データベース、サーバーサイド開発の知見',
	cloud: 'クラウド技術に関する日本語の技術記事を集約。AWS、GCP、Azureなどのクラウドサービス活用術',
	data: 'データエンジニアリングに関する日本語の技術記事を集約。データ分析、ETL、データ基盤構築の知見',
	devops: 'DevOps・SREに関する日本語の技術記事を集約。CI/CD、監視、インフラ自動化のベストプラクティス',
	frontend: 'フロントエンド開発に関する日本語の技術記事を集約。React、Vue、TypeScriptなどのWeb開発技術',
	mobile: 'モバイル開発に関する日本語の技術記事を集約。iOS、Android、Flutter、React Nativeの開発知見',
	oss: 'オープンソースに関する日本語の技術記事を集約。OSSへのコントリビュート、ライブラリ開発の知見',
	security: 'セキュリティに関する日本語の技術記事を集約。脆弱性対策、認証認可、セキュアコーディング',
	web3: 'Web3・ブロックチェーンに関する日本語の技術記事を集約。スマートコントラクト、DeFi、NFT技術',
}

export async function getStaticPaths() {
	const allPosts = await fetchAllPostsForSSG()

	return TOPICS.map((topic) => {
		const filteredPosts = allPosts.filter((post) => post.topics.includes(topic.id))
		return {
			params: { topic: topic.id },
			props: {
				topic,
				posts: filteredPosts,
				description: TOPIC_DESCRIPTIONS[topic.id],
			},
		}
	})
}

interface Props {
	topic: (typeof TOPICS)[number]
	posts: Awaited<ReturnType<typeof fetchAllPostsForSSG>>
	description: string
}

const { topic, posts, description } = Astro.props

// Structured data for CollectionPage
const structuredData = {
	'@context': 'https://schema.org',
	'@type': 'CollectionPage',
	name: `${topic.name}の技術記事`,
	description: description,
	url: new URL(`/topics/${topic.id}`, Astro.site).toString(),
	isPartOf: {
		'@type': 'WebSite',
		name: 'tail -f',
		url: Astro.site?.toString(),
	},
	numberOfItems: posts.length,
	mainEntity: {
		'@type': 'ItemList',
		numberOfItems: posts.length,
		itemListElement: posts.slice(0, 10).map((post, index) => ({
			'@type': 'ListItem',
			position: index + 1,
			url: post.url,
			name: post.title,
		})),
	},
}
---

<Layout title={`${topic.name}の技術記事`} description={description}>
	<Fragment slot="head">
		<script type="application/ld+json" set:html={JSON.stringify(structuredData)} />
	</Fragment>

	<div class="container mx-auto px-4 py-8">
		<div class="mb-8">
			<h1 class="text-3xl font-bold mb-2">#{topic.name}</h1>
			<p class="text-muted-foreground">{description}</p>
			<p class="text-sm text-muted-foreground mt-2">{posts.length}件の記事</p>
		</div>

		{posts.length > 0 ? (
			<div class="space-y-4">
				{posts.map((post) => (
					<PostCard post={post} />
				))}
			</div>
		) : (
			<p class="text-muted-foreground">このトピックの記事はまだありません。</p>
		)}

		<div class="mt-8">
			<a href="/topics" class="text-sm text-muted-foreground hover:text-foreground">
				← 全てのトピック
			</a>
		</div>
	</div>
</Layout>
